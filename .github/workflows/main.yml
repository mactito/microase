name: Microservices CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Newman runs on Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Newman
        run: npm install -g newman

      # Docker is already available on ubuntu-latest runners,
      # but buildx is useful and consistent.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------
      # 1) UNIT TESTS IN ISOLATION
      # ----------------------------

      - name: Build calc image
        run: docker build -t calc:ci .src/calc

      - name: Run calc container (isolated)
        run: |
          docker run -d --name calc_ci -p 5001:5000 calc:ci
          # simple wait
          for i in {1..30}; do
            curl -sSf http://localhost:5001/ >/dev/null && break || true
            sleep 1
          done

      - name: Newman - calc unit tests
        run: |
          newman run tests/calc_ut.postman_collection.json \
            --env-var baseUrl=http://localhost:5001

      - name: Stop calc container (always)
        if: always()
        run: |
          docker logs calc_ci || true
          docker rm -f calc_ci || true


      - name: Build string image
        run: docker build -t string:ci .src/string

      - name: Run string container (isolated)
        run: |
          docker run -d --name string_ci -p 5002:5000 string:ci
          for i in {1..30}; do
            curl -sSf http://localhost:5002/ >/dev/null && break || true
            sleep 1
          done

      - name: Newman - string unit tests
        run: |
          newman run tests/string_ut.postman_collection.json \
            --env-var baseUrl=http://localhost:5002

      - name: Stop string container (always)
        if: always()
        run: |
          docker logs string_ci || true
          docker rm -f string_ci || true


      # ----------------------------
      # 2) BUILD + RUN FULL ARCH
      # ----------------------------

      - name: Build full architecture
        run: docker compose build

      - name: Run full architecture (detached)
        run: |
          docker compose up -d
          # wait gateway
          for i in {1..60}; do
            curl -sSf http://localhost:5000/ >/dev/null && break || true
            sleep 2
          done

      # ----------------------------
      # 3) INTEGRATION TESTS
      # ----------------------------

      - name: Newman - integration tests (gateway)
        run: |
          newman run tests/integration.postman_collection.json \
            --env-var baseUrl=http://localhost:5000

      - name: Docker compose logs (always)
        if: always()
        run: docker compose logs --no-color

      - name: Stop full architecture (always)
        if: always()
        run: docker compose down -v
